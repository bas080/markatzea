#!/usr/bin/env bash

set -eu

tmpdir="$(mktemp -d)"

test -f "${1:-}" || {
  echo "markatzea <file>" >&2
  exit 1
}

csplit -s \
  --prefix="$tmpdir/$1." --suffix-format='%03d.part' \
  "$1" '/^```/' {*}

ls "$tmpdir/$1".*.part | while read -r file; do
  read -r lang comm < "$file"

  cat $file

  tmp="$(mktemp)"

  # [[ $lang != \`\`\` ]] || {
  #   printf '```\n`%s`\n' "$comm"
  # }

  [[ $lang != \`\`\`* ]] || {

    [[ -z "$comm" ]] || tail -n +2 "$file" | eval "$comm" > "$tmp" || {
      ec="$?"
      {
        printf "error: The following script exited with exit code %s.\n" "$ec"
        cat "$tmp"
        cat "$file"
        echo '```'
        echo 'Use "<interpreter> || true" to allow failure.\n'
      } >&2
      exit "$ec"
    }

    # printf '```\n`%s`\n```\n' "$comm"
    test ! -s "$tmp" || {
      printf '```\n```\n' "$comm"
      cat "$tmp"
    }

  }

done

rm -r "$tmpdir" # TODO: Perform in exit trap.
